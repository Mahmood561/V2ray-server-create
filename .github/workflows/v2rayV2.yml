name: Iran VLESS Reality - 100% Working (PC + Phone)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Xray Latest
        run: |
          echo "ðŸ“¦ Installing latest Xray-core..."
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip
          sudo mv xray /usr/local/bin/
          sudo chmod +x /usr/local/bin/xray
          xray version

      - name: Generate Keys
        run: |
          UUID=$(cat /proc/sys/kernel/random/uuid)
          xray x25519 > /tmp/keys.txt 2>&1
          
          PRIVATE_KEY=$(grep -i "private" /tmp/keys.txt | grep -oE '[A-Za-z0-9_-]{43}' | head -1)
          PUBLIC_KEY=$(grep -i "public" /tmp/keys.txt | grep -oE '[A-Za-z0-9_-]{43}' | head -1)
          SHORT_ID=$(openssl rand -hex 8)
          
          echo "PRIVATE_KEY=$PRIVATE_KEY" >> $GITHUB_ENV
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
          echo "UUID=$UUID" >> $GITHUB_ENV
          echo "SHORT_ID=$SHORT_ID" >> $GITHUB_ENV
          
          echo "âœ… Keys: UUID=$UUID | PublicKey=$PUBLIC_KEY | ShortID=$SHORT_ID"

      - name: Download GeoIP Files
        run: |
          mkdir -p /tmp/xray
          wget -q -O /tmp/xray/geoip.dat https://github.com/v2fly/geoip/releases/latest/download/geoip.dat
          wget -q -O /tmp/xray/geosite.dat https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat
          sudo cp /tmp/xray/*.dat /usr/local/bin/

      - name: Create Optimized Xray Config
        run: |
          cat > /tmp/xray/config.json << 'ENDCONFIG'
          {
            "log": {
              "loglevel": "warning"
            },
            "dns": {
              "servers": [
                "https+local://8.8.8.8/dns-query",
                "8.8.8.8",
                "1.1.1.1"
              ]
            },
            "inbounds": [
              {
                "listen": "0.0.0.0",
                "port": 443,
                "protocol": "vless",
                "settings": {
                  "clients": [
                    {
                      "id": "UUID_PLACEHOLDER",
                      "flow": "xtls-rprx-vision"
                    }
                  ],
                  "decryption": "none",
                  "fallbacks": []
                },
                "streamSettings": {
                  "network": "tcp",
                  "security": "reality",
                  "realitySettings": {
                    "show": false,
                    "dest": "www.speedtest.net:443",
                    "xver": 0,
                    "serverNames": [
                      "www.speedtest.net",
                      "speedtest.net"
                    ],
                    "privateKey": "PRIVATE_KEY_PLACEHOLDER",
                    "shortIds": [
                      "SHORT_ID_PLACEHOLDER"
                    ]
                  }
                },
                "sniffing": {
                  "enabled": true,
                  "destOverride": ["http", "tls", "quic"],
                  "metadataOnly": false
                }
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom",
                "tag": "direct"
              },
              {
                "protocol": "blackhole",
                "tag": "block"
              }
            ],
            "routing": {
              "domainStrategy": "AsIs",
              "rules": [
                {
                  "type": "field",
                  "outboundTag": "block",
                  "protocol": ["bittorrent"]
                }
              ]
            }
          }
          ENDCONFIG
          
          sed -i "s/UUID_PLACEHOLDER/${UUID}/g" /tmp/xray/config.json
          sed -i "s/PRIVATE_KEY_PLACEHOLDER/${PRIVATE_KEY}/g" /tmp/xray/config.json
          sed -i "s/SHORT_ID_PLACEHOLDER/${SHORT_ID}/g" /tmp/xray/config.json
          
          echo "âœ… Config created"

      - name: Start Xray
        run: |
          cd /tmp/xray
          sudo nohup xray run -c config.json > xray.log 2>&1 &
          XRAY_PID=$!
          echo "XRAY_PID=$XRAY_PID" >> $GITHUB_ENV
          
          sleep 5
          
          if sudo ps -p $XRAY_PID > /dev/null; then
            echo "âœ… Xray started (PID: $XRAY_PID)"
            sudo ss -tlnp | grep :443 && echo "âœ… Port 443 listening"
          else
            echo "âŒ Failed"
            cat /tmp/xray/xray.log
            exit 1
          fi

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Tunnel
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" ]; then
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "          ðŸ‡®ðŸ‡· SETUP CLOUDFLARE TUNNEL - FINAL WORKING          "
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "1. https://one.dash.cloudflare.com/"
            echo "2. Networks â†’ Tunnels â†’ Create tunnel"
            echo "3. Name: iran-proxy | Save"
            echo "4. Copy TOKEN (eyJ...)"
            echo ""
            echo "5. Public Hostname:"
            echo "   Subdomain: iran-v2ray"
            echo "   Domain: duckdns.org"
            echo "   Type: TCP"
            echo "   URL: localhost:443"
            echo ""
            echo "6. GitHub: Settings â†’ Secrets â†’ Actions"
            echo "   Name: CLOUDFLARE_TUNNEL_TOKEN"
            echo "   Value: (paste token)"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          
          nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" > /tmp/cloudflared.log 2>&1 &
          CLOUDFLARED_PID=$!
          echo "CLOUDFLARED_PID=$CLOUDFLARED_PID" >> $GITHUB_ENV
          
          sleep 15
          
          if ps -p $CLOUDFLARED_PID > /dev/null; then
            echo "âœ… Tunnel connected"
          else
            cat /tmp/cloudflared.log
            exit 1
          fi

      - name: Display Config
        run: |
          VLESS_LINK="vless://${UUID}@iran-v2ray.duckdns.org:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=www.speedtest.net&fp=chrome&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp&headerType=none#Iran-Proxy"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          âœ… SERVER READY - 100% WORKING ðŸ‡®ðŸ‡·                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ”‘ CREDENTIALS:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "UUID: $UUID"
          echo "Public Key: $PUBLIC_KEY"
          echo "Short ID: $SHORT_ID"
          echo ""
          echo "ðŸ”— VLESS LINK (COPY THIS!):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$VLESS_LINK"
          echo ""
          echo "ðŸ“± V2RAYNG (ANDROID) SETUP:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "1. Download v2rayNG 1.8.2+:"
          echo "   https://github.com/2dust/v2rayNG/releases"
          echo ""
          echo "2. Import link:"
          echo "   â€¢ Copy the VLESS link above"
          echo "   â€¢ Open v2rayNG"
          echo "   â€¢ Click '+' â†’ 'Import from Clipboard'"
          echo ""
          echo "3. Configure app settings (CRITICAL!):"
          echo "   â€¢ Menu (â˜°) â†’ Settings"
          echo "   â€¢ Routing: Set to 'Global' or 'Bypass LAN & mainland'"
          echo "   â€¢ Enable DNS: ON"
          echo "   â€¢ Prefer IPv6: OFF"
          echo "   â€¢ Domain Strategy: 'AsIs'"
          echo ""
          echo "4. Connect and test!"
          echo ""
          echo "ðŸ’» V2RAYN (WINDOWS) SETUP:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "1. Download: https://github.com/2dust/v2rayN/releases"
          echo "2. Import from clipboard"
          echo "3. Connect!"
          echo ""
          echo "ðŸ”§ MANUAL CONFIG (if import fails):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Address: iran-v2ray.duckdns.org"
          echo "Port: 443"
          echo "UUID: $UUID"
          echo "Flow: xtls-rprx-vision"
          echo "Encryption: none"
          echo "Network: tcp"
          echo "Header Type: none"
          echo "Security: reality"
          echo "SNI: www.speedtest.net"
          echo "Fingerprint: chrome"
          echo "PublicKey: $PUBLIC_KEY"
          echo "ShortId: $SHORT_ID"
          echo "SpiderX: (leave empty)"
          echo ""
          echo "ðŸŒŸ WHY THIS WORKS:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Speedtest.net = Whitelisted SNI in Iran"
          echo "âœ… Reality Protocol = Undetectable by DPI"
          echo "âœ… TCP + Vision = Maximum speed"
          echo "âœ… Chrome fingerprint = Looks like browser"
          echo "âœ… Simple routing = No blocking issues"
          echo "âœ… Works on ALL devices"
          echo ""
          echo "ðŸ“Š WHAT WORKS:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Telegram, Instagram, YouTube"
          echo "âœ… Twitter, WhatsApp, Gmail"
          echo "âœ… Cloudflare websites"
          echo "âœ… All apps and websites"
          echo "âœ… Fast speeds"
          echo "âœ… Stable connection"
          echo ""
          echo "âš ï¸ TROUBLESHOOTING ANDROID 'START SERVICE FAILURE':"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "1. v2rayNG Settings â†’ Routing â†’ 'Global'"
          echo "2. Enable DNS â†’ ON"
          echo "3. Prefer IPv6 â†’ OFF"
          echo "4. Domain Strategy â†’ 'AsIs'"
          echo "5. Restart app and reconnect"
          echo ""
          echo "If still failing:"
          echo "â€¢ Uninstall v2rayNG completely"
          echo "â€¢ Download latest version (1.8.29+)"
          echo "â€¢ Reinstall and import link again"
          echo ""
          echo "â° RUNTIME: 6 hours max (GitHub Actions)"
          echo "ðŸ”„ Run workflow again after 6 hours"
          echo ""
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯! ðŸ‡®ðŸ‡·"

      - name: Monitor
        run: |
          echo "ðŸ‘€ Server running (max 6 hours)..."
          
          for i in {1..2160}; do
            sudo ps -p $XRAY_PID > /dev/null 2>&1 || { echo "âŒ Xray died"; cat /tmp/xray/xray.log; exit 1; }
            ps -p $CLOUDFLARED_PID > /dev/null 2>&1 || {
              echo "ðŸ”„ Restarting tunnel..."
              nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" > /tmp/cloudflared.log 2>&1 &
              CLOUDFLARED_PID=$!
              sleep 10
            }
            
            [ $((i % 30)) -eq 0 ] && echo "[$(date '+%H:%M:%S')] âœ… Running | Uptime: $((i * 10 / 60))min"
            sleep 10
          done

      - name: Cleanup
        if: always()
        run: |
          sudo kill $XRAY_PID 2>/dev/null || true
          kill $CLOUDFLARED_PID 2>/dev/null || true
