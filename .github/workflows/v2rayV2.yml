name: Iran Dual Protocol - VLESS WebSocket (PC + Android)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Xray
        run: |
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip
          sudo mv xray /usr/local/bin/
          sudo chmod +x /usr/local/bin/xray
          xray version

      - name: Generate Keys
        run: |
          UUID_PC=$(cat /proc/sys/kernel/random/uuid)
          UUID_ANDROID=$(cat /proc/sys/kernel/random/uuid)
          
          echo "UUID_PC=$UUID_PC" >> $GITHUB_ENV
          echo "UUID_ANDROID=$UUID_ANDROID" >> $GITHUB_ENV
          
          echo "PC UUID: $UUID_PC"
          echo "Android UUID: $UUID_ANDROID"

      - name: Download GeoIP
        run: |
          mkdir -p /tmp/xray
          wget -q -O /tmp/xray/geoip.dat https://github.com/v2fly/geoip/releases/latest/download/geoip.dat
          wget -q -O /tmp/xray/geosite.dat https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat
          sudo cp /tmp/xray/*.dat /usr/local/bin/

      - name: Create Dual VLESS WebSocket Config
        run: |
          cat > /tmp/xray/config.json << ENDCONFIG
          {
            "log": {"loglevel": "warning"},
            "inbounds": [
              {
                "listen": "127.0.0.1",
                "port": 8081,
                "protocol": "vless",
                "tag": "pc-inbound",
                "settings": {
                  "clients": [{"id": "${UUID_PC}"}],
                  "decryption": "none"
                },
                "streamSettings": {
                  "network": "ws",
                  "security": "none",
                  "wsSettings": {
                    "path": "/pc"
                  }
                },
                "sniffing": {"enabled": true, "destOverride": ["http", "tls", "quic"]}
              },
              {
                "listen": "127.0.0.1",
                "port": 8082,
                "protocol": "vless",
                "tag": "android-inbound",
                "settings": {
                  "clients": [{"id": "${UUID_ANDROID}"}],
                  "decryption": "none"
                },
                "streamSettings": {
                  "network": "ws",
                  "security": "none",
                  "wsSettings": {
                    "path": "/android"
                  }
                },
                "sniffing": {"enabled": true, "destOverride": ["http", "tls", "quic"]}
              }
            ],
            "outbounds": [
              {"protocol": "freedom", "tag": "direct"}
            ]
          }
          ENDCONFIG
          
          echo "Dual VLESS WebSocket config created"

      - name: Start Xray
        run: |
          cd /tmp/xray
          sudo nohup xray run -c config.json > xray.log 2>&1 &
          sleep 5
          
          if sudo ss -tlnp | grep -E ":(8081|8082)"; then
            echo "Xray started on ports 8081 (PC) and 8082 (Android)"
          else
            echo "Xray failed to start:"
            cat /tmp/xray/xray.log
            exit 1
          fi

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Quick Tunnels
        run: |
          # Start PC tunnel (quick tunnel - no config needed)
          nohup cloudflared tunnel --url http://localhost:8081 --no-autoupdate > /tmp/cf-pc.log 2>&1 &
          CF_PC_PID=$!
          echo "CF_PC_PID=$CF_PC_PID" >> $GITHUB_ENV
          
          # Start Android tunnel (quick tunnel - no config needed)
          nohup cloudflared tunnel --url http://localhost:8082 --no-autoupdate > /tmp/cf-android.log 2>&1 &
          CF_ANDROID_PID=$!
          echo "CF_ANDROID_PID=$CF_ANDROID_PID" >> $GITHUB_ENV
          
          echo "Waiting for tunnels to initialize..."
          sleep 20
          
          # Extract tunnel URLs
          PC_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/cf-pc.log | head -1)
          ANDROID_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/cf-android.log | head -1)
          
          if [ -z "$PC_URL" ] || [ -z "$ANDROID_URL" ]; then
            echo "Waiting more for tunnel URLs..."
            sleep 20
            PC_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/cf-pc.log | head -1)
            ANDROID_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/cf-android.log | head -1)
          fi
          
          if [ -z "$PC_URL" ] || [ -z "$ANDROID_URL" ]; then
            echo "Failed to get tunnel URLs"
            echo "PC tunnel log:"
            cat /tmp/cf-pc.log
            echo "Android tunnel log:"
            cat /tmp/cf-android.log
            exit 1
          fi
          
          # Extract hostnames
          PC_HOST=$(echo "$PC_URL" | sed 's|https://||')
          ANDROID_HOST=$(echo "$ANDROID_URL" | sed 's|https://||')
          
          echo "PC_HOST=$PC_HOST" >> $GITHUB_ENV
          echo "ANDROID_HOST=$ANDROID_HOST" >> $GITHUB_ENV
          
          echo "Tunnels created successfully!"
          echo "PC Tunnel: $PC_URL"
          echo "Android Tunnel: $ANDROID_URL"

      - name: Display Connection Info
        run: |
          echo ""
          echo "================================================================"
          echo "     DUAL VLESS WEBSOCKET - PC + ANDROID READY"
          echo "================================================================"
          echo ""
          echo "--- PC CONNECTION (v2rayN / Nekoray / Hiddify) ---"
          echo ""
          echo "VLESS Link (copy this):"
          echo "vless://${UUID_PC}@${PC_HOST}:443?encryption=none&security=tls&sni=${PC_HOST}&fp=chrome&type=ws&host=${PC_HOST}&path=%2Fpc#Iran-PC"
          echo ""
          echo "Manual Config:"
          echo "  Protocol: VLESS"
          echo "  Address: ${PC_HOST}"
          echo "  Port: 443"
          echo "  UUID: ${UUID_PC}"
          echo "  Encryption: none"
          echo "  Network: ws"
          echo "  Path: /pc"
          echo "  TLS: Enable"
          echo "  SNI: ${PC_HOST}"
          echo "  Fingerprint: chrome"
          echo ""
          echo "--- ANDROID CONNECTION (v2rayNG) ---"
          echo ""
          echo "VLESS Link (copy this):"
          echo "vless://${UUID_ANDROID}@${ANDROID_HOST}:443?encryption=none&security=tls&sni=${ANDROID_HOST}&fp=firefox&type=ws&host=${ANDROID_HOST}&path=%2Fandroid#Iran-Android"
          echo ""
          echo "Manual Config:"
          echo "  Protocol: VLESS"
          echo "  Address: ${ANDROID_HOST}"
          echo "  Port: 443"
          echo "  UUID: ${UUID_ANDROID}"
          echo "  Encryption: none"
          echo "  Network: ws"
          echo "  Path: /android"
          echo "  TLS: Enable"
          echo "  SNI: ${ANDROID_HOST}"
          echo "  Fingerprint: firefox"
          echo ""
          echo "--- SETUP INSTRUCTIONS ---"
          echo ""
          echo "PC (v2rayN):"
          echo "  1. Download: https://github.com/2dust/v2rayN/releases"
          echo "  2. Copy the VLESS link above"
          echo "  3. In v2rayN: Servers -> Import from clipboard"
          echo "  4. Click Connect"
          echo ""
          echo "Android (v2rayNG):"
          echo "  1. Download from Play Store or:"
          echo "     https://github.com/2dust/v2rayNG/releases"
          echo "  2. Copy the VLESS link above"
          echo "  3. Tap + -> Import from clipboard"
          echo "  4. Tap the play button"
          echo ""
          echo "--- INFO ---"
          echo "  Runtime: 6 hours max"
          echo "  Protocol: VLESS + WebSocket + TLS"
          echo "  Tunnels: Cloudflare Quick Tunnels (no setup needed)"
          echo ""
          echo "================================================================"

      - name: Monitor
        run: |
          echo "Monitoring tunnels for 6 hours..."
          
          for i in {1..2160}; do
            # Check if Xray is running
            if ! sudo ss -tlnp | grep -q ":8081"; then
              echo "Xray died, restarting..."
              cd /tmp/xray
              sudo nohup xray run -c config.json > xray.log 2>&1 &
              sleep 5
            fi
            
            # Check PC tunnel
            if ! ps -p $CF_PC_PID > /dev/null 2>&1; then
              echo "Restarting PC tunnel..."
              nohup cloudflared tunnel --url http://localhost:8081 --no-autoupdate > /tmp/cf-pc.log 2>&1 &
              CF_PC_PID=$!
              sleep 15
              NEW_PC_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/cf-pc.log | head -1)
              if [ -n "$NEW_PC_URL" ]; then
                NEW_PC_HOST=$(echo "$NEW_PC_URL" | sed 's|https://||')
                echo "New PC URL: $NEW_PC_URL"
                echo "New PC VLESS: vless://${UUID_PC}@${NEW_PC_HOST}:443?encryption=none&security=tls&sni=${NEW_PC_HOST}&fp=chrome&type=ws&host=${NEW_PC_HOST}&path=%2Fpc#Iran-PC"
              fi
            fi
            
            # Check Android tunnel
            if ! ps -p $CF_ANDROID_PID > /dev/null 2>&1; then
              echo "Restarting Android tunnel..."
              nohup cloudflared tunnel --url http://localhost:8082 --no-autoupdate > /tmp/cf-android.log 2>&1 &
              CF_ANDROID_PID=$!
              sleep 15
              NEW_ANDROID_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/cf-android.log | head -1)
              if [ -n "$NEW_ANDROID_URL" ]; then
                NEW_ANDROID_HOST=$(echo "$NEW_ANDROID_URL" | sed 's|https://||')
                echo "New Android URL: $NEW_ANDROID_URL"
                echo "New Android VLESS: vless://${UUID_ANDROID}@${NEW_ANDROID_HOST}:443?encryption=none&security=tls&sni=${NEW_ANDROID_HOST}&fp=firefox&type=ws&host=${NEW_ANDROID_HOST}&path=%2Fandroid#Iran-Android"
              fi
            fi
            
            [ $((i % 60)) -eq 0 ] && echo "[$(date '+%H:%M:%S')] Running | $((i * 10 / 60))min elapsed"
            sleep 10
          done

      - name: Cleanup
        if: always()
        run: |
          sudo pkill -f xray || true
          kill $CF_PC_PID 2>/dev/null || true
          kill $CF_ANDROID_PID 2>/dev/null || true
          echo "Cleanup complete"
