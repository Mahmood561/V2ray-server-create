name: Iran Dual Protocol - PC (Reality) + Android (VMess WS)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Xray
        run: |
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip
          sudo mv xray /usr/local/bin/
          sudo chmod +x /usr/local/bin/xray
          xray version

      - name: Generate Keys
        run: |
          UUID=$(cat /proc/sys/kernel/random/uuid)
          UUID_ANDROID=$(cat /proc/sys/kernel/random/uuid)
          xray x25519 > /tmp/keys.txt 2>&1
          
          PRIVATE_KEY=$(grep -i "private" /tmp/keys.txt | grep -oE '[A-Za-z0-9_-]{43}' | head -1)
          PUBLIC_KEY=$(grep -i "public" /tmp/keys.txt | grep -oE '[A-Za-z0-9_-]{43}' | head -1)
          SHORT_ID=$(openssl rand -hex 8)
          
          echo "PRIVATE_KEY=$PRIVATE_KEY" >> $GITHUB_ENV
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
          echo "UUID=$UUID" >> $GITHUB_ENV
          echo "UUID_ANDROID=$UUID_ANDROID" >> $GITHUB_ENV
          echo "SHORT_ID=$SHORT_ID" >> $GITHUB_ENV
          
          echo "âœ… PC UUID: $UUID"
          echo "âœ… Android UUID: $UUID_ANDROID"
          echo "âœ… Public Key: $PUBLIC_KEY"

      - name: Download GeoIP
        run: |
          mkdir -p /tmp/xray
          wget -q -O /tmp/xray/geoip.dat https://github.com/v2fly/geoip/releases/latest/download/geoip.dat
          wget -q -O /tmp/xray/geosite.dat https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat
          sudo cp /tmp/xray/*.dat /usr/local/bin/

      - name: Create Dual Protocol Config
        run: |
          cat > /tmp/xray/config.json << ENDCONFIG
          {
            "log": {"loglevel": "warning"},
            "inbounds": [
              {
                "listen": "0.0.0.0",
                "port": 443,
                "protocol": "vless",
                "settings": {
                  "clients": [{"id": "${UUID}", "flow": "xtls-rprx-vision"}],
                  "decryption": "none"
                },
                "streamSettings": {
                  "network": "tcp",
                  "security": "reality",
                  "realitySettings": {
                    "show": false,
                    "dest": "www.microsoft.com:443",
                    "xver": 0,
                    "serverNames": ["www.microsoft.com", "microsoft.com"],
                    "privateKey": "${PRIVATE_KEY}",
                    "shortIds": ["${SHORT_ID}", ""]
                  }
                },
                "sniffing": {"enabled": true, "destOverride": ["http", "tls", "quic"]}
              },
              {
                "listen": "0.0.0.0",
                "port": 8080,
                "protocol": "vmess",
                "settings": {
                  "clients": [{"id": "${UUID_ANDROID}", "alterId": 0}]
                },
                "streamSettings": {
                  "network": "ws",
                  "wsSettings": {
                    "path": "/ray",
                    "headers": {
                      "Host": "iran-android.duckdns.org"
                    }
                  }
                },
                "sniffing": {"enabled": true, "destOverride": ["http", "tls", "quic"]}
              }
            ],
            "outbounds": [{"protocol": "freedom"}]
          }
          ENDCONFIG
          
          echo "âœ… Dual protocol config created"

      - name: Start Xray
        run: |
          cd /tmp/xray
          sudo nohup xray run -c config.json > xray.log 2>&1 &
          XRAY_PID=$!
          echo "XRAY_PID=$XRAY_PID" >> $GITHUB_ENV
          sleep 5
          
          if sudo ps -p $XRAY_PID > /dev/null; then
            echo "âœ… Xray started (PID: $XRAY_PID)"
            sudo ss -tlnp | grep -E ':(443|8080)'
          else
            echo "âŒ Xray failed to start"
            cat /tmp/xray/xray.log
            exit 1
          fi

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Tunnels (BOTH)
        run: |
          if [ -z "${{ secrets.CF_TUNNEL_REALITY }}" ] || [ -z "${{ secrets.CF_TUNNEL_VMESS }}" ]; then
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "       DUAL TUNNEL SETUP - PC (Reality) + Android (VMess)"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "YOU NEED 2 CLOUDFLARE TUNNELS:"
            echo ""
            echo "TUNNEL 1 - FOR PC (Reality/TCP):"
            echo "1. https://one.dash.cloudflare.com/"
            echo "2. Create tunnel: iran-reality"
            echo "3. Copy TOKEN"
            echo "4. Public Hostname:"
            echo "   Subdomain: iran-pc"
            echo "   Domain: duckdns.org"
            echo "   Type: TCP"
            echo "   URL: localhost:443"
            echo "5. GitHub Secret:"
            echo "   Name: CF_TUNNEL_REALITY"
            echo "   Value: (paste token)"
            echo ""
            echo "TUNNEL 2 - FOR ANDROID (VMess/WebSocket):"
            echo "1. Create tunnel: iran-android"
            echo "2. Copy TOKEN"
            echo "3. Public Hostname:"
            echo "   Subdomain: iran-android"
            echo "   Domain: duckdns.org"
            echo "   Type: HTTP"
            echo "   URL: http://localhost:8080"
            echo "4. GitHub Secret:"
            echo "   Name: CF_TUNNEL_VMESS"
            echo "   Value: (paste token)"
            echo ""
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          
          # Start Reality tunnel (PC)
          nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_REALITY }}" > /tmp/cf-reality.log 2>&1 &
          CF_REALITY_PID=$!
          echo "CF_REALITY_PID=$CF_REALITY_PID" >> $GITHUB_ENV
          
          # Start VMess tunnel (Android)
          nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_VMESS }}" > /tmp/cf-vmess.log 2>&1 &
          CF_VMESS_PID=$!
          echo "CF_VMESS_PID=$CF_VMESS_PID" >> $GITHUB_ENV
          
          sleep 15
          
          echo "Checking tunnel status..."
          if ps -p $CF_REALITY_PID > /dev/null && ps -p $CF_VMESS_PID > /dev/null; then
            echo "âœ… Both tunnels running!"
            echo "Reality PID: $CF_REALITY_PID"
            echo "VMess PID: $CF_VMESS_PID"
          else
            echo "âŒ Tunnel failed"
            echo "=== Reality Tunnel Log ==="
            cat /tmp/cf-reality.log
            echo "=== VMess Tunnel Log ==="
            cat /tmp/cf-vmess.log
            exit 1
          fi

      - name: Display Connection Info
        run: |
          VMESS_JSON="{\"v\":\"2\",\"ps\":\"Iran-Android\",\"add\":\"iran-android.duckdns.org\",\"port\":\"443\",\"id\":\"${UUID_ANDROID}\",\"aid\":\"0\",\"net\":\"ws\",\"type\":\"none\",\"host\":\"iran-android.duckdns.org\",\"path\":\"/ray\",\"tls\":\"tls\",\"sni\":\"iran-android.duckdns.org\",\"alpn\":\"\"}"
          VMESS_LINK="vmess://$(echo -n "$VMESS_JSON" | base64 -w 0)"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                              â•‘"
          echo "â•‘      âœ… DUAL PROTOCOL - PC + ANDROID WORKING! ðŸ‡®ðŸ‡·           â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ’» FOR PC/LAPTOP (FAST - Reality Protocol):"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "Address: iran-pc.duckdns.org"
          echo "Port: 443"
          echo "UUID: $UUID"
          echo "Flow: xtls-rprx-vision"
          echo "Security: reality"
          echo "SNI: www.microsoft.com"
          echo "Fingerprint: chrome"
          echo "PublicKey: $PUBLIC_KEY"
          echo "ShortId: $SHORT_ID"
          echo ""
          echo "VLESS Link (PC):"
          echo "vless://${UUID}@iran-pc.duckdns.org:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=www.microsoft.com&fp=chrome&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp#Iran-PC"
          echo ""
          echo "ðŸ“± FOR ANDROID (RELIABLE - VMess WebSocket):"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "VMess Link (Android):"
          echo "$VMESS_LINK"
          echo ""
          echo "OR Manual Config:"
          echo "Protocol: VMess"
          echo "Address: iran-android.duckdns.org"
          echo "Port: 443"
          echo "UUID: $UUID_ANDROID"
          echo "AlterID: 0"
          echo "Network: ws"
          echo "Path: /ray"
          echo "Host: iran-android.duckdns.org"
          echo "TLS: Enable"
          echo "SNI: iran-android.duckdns.org"
          echo ""
          echo "ðŸ“² ANDROID SETUP:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "1. Download v2rayNG from Play Store or:"
          echo "   https://github.com/2dust/v2rayNG/releases"
          echo "2. Open app"
          echo "3. Click '+' â†’ 'Import from Clipboard'"
          echo "4. Paste the VMess link above"
          echo "5. Connect - WORKS INSTANTLY!"
          echo ""
          echo "ðŸ’» PC SETUP:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "1. Download v2rayN:"
          echo "   https://github.com/2dust/v2rayN/releases"
          echo "2. Import VLESS link from clipboard"
          echo "3. Connect!"
          echo ""
          echo "ðŸ”¥ KEY FEATURES:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ… PC: Reality (FAST, undetectable)"
          echo "âœ… Android: VMess+WS (RELIABLE, always works)"
          echo "âœ… 2 separate tunnels = MORE STABLE"
          echo "âœ… Tunnels run independently = NO BROWSER NEEDED!"
          echo "âœ… Different UUIDs for security"
          echo "âœ… Both run for 6 hours"
          echo ""
          echo "ðŸŒŸ WHAT WAS FIXED:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ… VMess now listens on 0.0.0.0 (was 127.0.0.1)"
          echo "âœ… Added proper WebSocket headers with Host"
          echo "âœ… Added traffic sniffing to VMess"
          echo "âœ… Improved error checking and logs"
          echo ""
          echo "â° RUNTIME: 6 hours max"
          echo "ðŸ”„ Run workflow again after 6 hours"
          echo "ðŸ’¡ UUIDs stay the same"
          echo ""
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯! ðŸ‡®ðŸ‡·"

      - name: Monitor
        run: |
          echo "ðŸ‘€ Monitoring both tunnels (6 hours max)..."
          
          for i in {1..2160}; do
            # Check Xray
            if ! sudo ps -p $XRAY_PID > /dev/null 2>&1; then
              echo "âŒ Xray died at $(date)"
              cat /tmp/xray/xray.log
              exit 1
            fi
            
            # Check Reality tunnel
            if ! ps -p $CF_REALITY_PID > /dev/null 2>&1; then
              echo "ðŸ”„ Restarting Reality tunnel at $(date)..."
              nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_REALITY }}" > /tmp/cf-reality.log 2>&1 &
              CF_REALITY_PID=$!
              echo "CF_REALITY_PID=$CF_REALITY_PID" >> $GITHUB_ENV
              sleep 10
            fi
            
            # Check VMess tunnel
            if ! ps -p $CF_VMESS_PID > /dev/null 2>&1; then
              echo "ðŸ”„ Restarting VMess tunnel at $(date)..."
              nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_VMESS }}" > /tmp/cf-vmess.log 2>&1 &
              CF_VMESS_PID=$!
              echo "CF_VMESS_PID=$CF_VMESS_PID" >> $GITHUB_ENV
              sleep 10
            fi
            
            if [ $((i % 30)) -eq 0 ]; then
              echo "[$(date '+%H:%M:%S')] âœ… All running | $((i * 10 / 60))min elapsed"
            fi
            
            sleep 10
          done
          
          echo "â° 6 hour limit reached. Shutting down gracefully."

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up processes..."
          sudo kill $XRAY_PID 2>/dev/null || true
          kill $CF_REALITY_PID 2>/dev/null || true
          kill $CF_VMESS_PID 2>/dev/null || true
          echo "âœ… Cleanup complete"
