name: Iran VLESS Proxy Working

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Xray
        run: |
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip
          sudo mv xray /usr/local/bin/
          sudo chmod +x /usr/local/bin/xray
          xray version

      - name: Generate Credentials
        run: |
          UUID_PC=$(cat /proc/sys/kernel/random/uuid)
          UUID_MOBILE=$(cat /proc/sys/kernel/random/uuid)
          xray x25519 > /tmp/keys.txt 2>&1
          PRIVATE_KEY=$(cat /tmp/keys.txt | grep -i "private key" | awk '{print $NF}')
          PUBLIC_KEY=$(cat /tmp/keys.txt | grep -i "public key" | awk '{print $NF}')
          if [ -z "$PRIVATE_KEY" ]; then
            PRIVATE_KEY=$(cat /tmp/keys.txt | grep -oE '[A-Za-z0-9_-]{43,44}' | head -1)
            PUBLIC_KEY=$(cat /tmp/keys.txt | grep -oE '[A-Za-z0-9_-]{43,44}' | tail -1)
          fi
          SHORT_ID=$(openssl rand -hex 8)
          echo "$PRIVATE_KEY" > /tmp/priv.key
          echo "$PUBLIC_KEY" > /tmp/pub.key
          echo "$UUID_PC" > /tmp/uuid_pc
          echo "$UUID_MOBILE" > /tmp/uuid_mob
          echo "$SHORT_ID" > /tmp/sid
          echo "PRIVATE_KEY=$PRIVATE_KEY" >> $GITHUB_ENV
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
          echo "UUID_PC=$UUID_PC" >> $GITHUB_ENV
          echo "UUID_MOBILE=$UUID_MOBILE" >> $GITHUB_ENV
          echo "SHORT_ID=$SHORT_ID" >> $GITHUB_ENV
          echo "PC UUID: $UUID_PC"
          echo "Mobile UUID: $UUID_MOBILE"
          echo "Public Key: $PUBLIC_KEY"
          echo "Short ID: $SHORT_ID"

      - name: Setup Xray
        run: |
          mkdir -p /tmp/xray
          wget -q -O /tmp/xray/geoip.dat https://github.com/v2fly/geoip/releases/latest/download/geoip.dat
          wget -q -O /tmp/xray/geosite.dat https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat
          sudo cp /tmp/xray/*.dat /usr/local/bin/

      - name: Create Config
        run: |
          PRIV=$(cat /tmp/priv.key)
          PUB=$(cat /tmp/pub.key)
          UPC=$(cat /tmp/uuid_pc)
          UMOB=$(cat /tmp/uuid_mob)
          SID=$(cat /tmp/sid)
          python3 -c "
import json
cfg = {
  'log': {'loglevel': 'info'},
  'inbounds': [
    {
      'tag': 'pc-reality',
      'listen': '0.0.0.0',
      'port': 443,
      'protocol': 'vless',
      'settings': {
        'clients': [{'id': '$UPC', 'flow': 'xtls-rprx-vision'}],
        'decryption': 'none'
      },
      'streamSettings': {
        'network': 'tcp',
        'security': 'reality',
        'realitySettings': {
          'show': False,
          'dest': 'www.microsoft.com:443',
          'xver': 0,
          'serverNames': ['www.microsoft.com', 'microsoft.com'],
          'privateKey': '$PRIV',
          'shortIds': ['$SID', '']
        }
      },
      'sniffing': {'enabled': True, 'destOverride': ['http', 'tls', 'quic']}
    },
    {
      'tag': 'mobile-ws',
      'listen': '0.0.0.0',
      'port': 8080,
      'protocol': 'vless',
      'settings': {
        'clients': [{'id': '$UMOB'}],
        'decryption': 'none'
      },
      'streamSettings': {
        'network': 'ws',
        'wsSettings': {'path': '/vless-ws'}
      },
      'sniffing': {'enabled': True, 'destOverride': ['http', 'tls', 'quic']}
    }
  ],
  'outbounds': [{'protocol': 'freedom', 'tag': 'direct'}]
}
with open('/tmp/xray/config.json', 'w') as f:
  json.dump(cfg, f, indent=2)
"
          cat /tmp/xray/config.json

      - name: Start Xray
        run: |
          cd /tmp/xray
          sudo xray run -c config.json > xray.log 2>&1 &
          XRAY_PID=$!
          echo "XRAY_PID=$XRAY_PID" >> $GITHUB_ENV
          sleep 10
          tail -30 xray.log
          sudo ss -tlnp | grep -E ':(443|8080)'
          if ! sudo ps -p $XRAY_PID > /dev/null; then
            echo "Xray failed"
            cat xray.log
            exit 1
          fi

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Check Secrets
        run: |
          if [ -z "${{ secrets.CF_TUNNEL_PC }}" ] || [ -z "${{ secrets.CF_TUNNEL_MOBILE }}" ]; then
            echo "================================================"
            echo "SETUP CLOUDFLARE TUNNELS"
            echo "================================================"
            echo ""
            echo "TUNNEL 1 - PC (Reality):"
            echo "1. https://one.dash.cloudflare.com/"
            echo "2. Networks > Tunnels > Create tunnel"
            echo "3. Name: iran-pc"
            echo "4. Copy token"
            echo "5. Public hostname:"
            echo "   - Subdomain: iran-pc"
            echo "   - Service: TCP"
            echo "   - URL: localhost:443"
            echo "6. Add GitHub secret: CF_TUNNEL_PC"
            echo ""
            echo "TUNNEL 2 - MOBILE (WebSocket):"
            echo "1. Create tunnel: iran-mobile"
            echo "2. Copy token"
            echo "3. Public hostname:"
            echo "   - Subdomain: iran-mobile"
            echo "   - Service: HTTP"
            echo "   - URL: http://localhost:8080"
            echo "4. Add GitHub secret: CF_TUNNEL_MOBILE"
            echo ""
            echo "================================================"
            exit 1
          fi

      - name: Start Tunnels
        run: |
          cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_PC }}" > /tmp/cf-pc.log 2>&1 &
          CF_PC_PID=$!
          echo "CF_PC_PID=$CF_PC_PID" >> $GITHUB_ENV
          cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_MOBILE }}" > /tmp/cf-mobile.log 2>&1 &
          CF_MOBILE_PID=$!
          echo "CF_MOBILE_PID=$CF_MOBILE_PID" >> $GITHUB_ENV
          sleep 25
          tail -20 /tmp/cf-pc.log
          tail -20 /tmp/cf-mobile.log
          if ! ps -p $CF_PC_PID > /dev/null || ! ps -p $CF_MOBILE_PID > /dev/null; then
            echo "Tunnel failed"
            exit 1
          fi
          echo "Tunnels running: PC=$CF_PC_PID MOBILE=$CF_MOBILE_PID"

      - name: Display Info
        run: |
          PUB=$(cat /tmp/pub.key)
          UPC=$(cat /tmp/uuid_pc)
          UMOB=$(cat /tmp/uuid_mob)
          SID=$(cat /tmp/sid)
          
          PC_DOMAIN="iran-pc.your-domain.com"
          MOB_DOMAIN="iran-mobile.your-domain.com"
          
          echo ""
          echo "================================================"
          echo "VLESS PROXY READY"
          echo "================================================"
          echo ""
          echo "UPDATE DOMAINS IN WORKFLOW (lines 137-138)!"
          echo ""
          echo "PC REALITY:"
          echo "vless://${UPC}@${PC_DOMAIN}:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=www.microsoft.com&fp=chrome&pbk=${PUB}&sid=${SID}&type=tcp#Iran-PC"
          echo ""
          echo "MOBILE WEBSOCKET:"
          echo "vless://${UMOB}@${MOB_DOMAIN}:443?encryption=none&security=tls&sni=${MOB_DOMAIN}&fp=chrome&type=ws&host=${MOB_DOMAIN}&path=%2Fvless-ws#Iran-Mobile"
          echo ""
          echo "Manual PC Config:"
          echo "  Address: $PC_DOMAIN"
          echo "  Port: 443"
          echo "  UUID: $UPC"
          echo "  Flow: xtls-rprx-vision"
          echo "  Security: reality"
          echo "  SNI: www.microsoft.com"
          echo "  PublicKey: $PUB"
          echo "  ShortId: $SID"
          echo ""
          echo "Manual Mobile Config:"
          echo "  Address: $MOB_DOMAIN"
          echo "  Port: 443"
          echo "  UUID: $UMOB"
          echo "  Security: tls"
          echo "  Network: ws"
          echo "  Path: /vless-ws"
          echo ""
          echo "Runtime: 6 hours"
          echo "================================================"

      - name: Monitor
        run: |
          echo "Monitoring for 6 hours..."
          for i in {1..2160}; do
            if ! sudo ps -p $XRAY_PID > /dev/null 2>&1; then
              echo "Xray died"
              tail -50 /tmp/xray/xray.log
              exit 1
            fi
            if ! ps -p $CF_PC_PID > /dev/null 2>&1; then
              echo "Restarting PC tunnel"
              cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_PC }}" > /tmp/cf-pc.log 2>&1 &
              CF_PC_PID=$!
              echo "CF_PC_PID=$CF_PC_PID" >> $GITHUB_ENV
            fi
            if ! ps -p $CF_MOBILE_PID > /dev/null 2>&1; then
              echo "Restarting Mobile tunnel"
              cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_MOBILE }}" > /tmp/cf-mobile.log 2>&1 &
              CF_MOBILE_PID=$!
              echo "CF_MOBILE_PID=$CF_MOBILE_PID" >> $GITHUB_ENV
            fi
            if [ $((i % 30)) -eq 0 ]; then
              echo "[$(date '+%H:%M:%S')] Running: $((i*10/60))min"
            fi
            sleep 10
          done

      - name: Cleanup
        if: always()
        run: |
          sudo kill $XRAY_PID 2>/dev/null || true
          kill $CF_PC_PID 2>/dev/null || true
          kill $CF_MOBILE_PID 2>/dev/null || true
