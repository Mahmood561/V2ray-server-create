name: Iran VLESS Reality - Fixed Keys (PC + Android)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Xray
        run: |
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip
          sudo mv xray /usr/local/bin/
          sudo chmod +x /usr/local/bin/xray
          xray version

      - name: Generate Keys (FIXED)
        run: |
          echo "ðŸ”‘ Generating Reality keys..."
          
          # Generate UUID
          UUID=$(cat /proc/sys/kernel/random/uuid)
          echo "UUID=$UUID" >> $GITHUB_ENV
          
          # Generate X25519 keys - PROPER METHOD
          xray x25519 > /tmp/keys.txt 2>&1
          
          echo "ðŸ“„ Raw key output:"
          cat /tmp/keys.txt
          echo ""
          
          # Extract keys - NEW XRAY FORMAT
          # PrivateKey: xxx
          # Password: yyy (this is actually the public key!)
          PRIVATE_KEY=$(grep "PrivateKey:" /tmp/keys.txt | cut -d: -f2 | tr -d ' ')
          PUBLIC_KEY=$(grep "Password:" /tmp/keys.txt | cut -d: -f2 | tr -d ' ')
          
          # Generate Short ID
          SHORT_ID=$(openssl rand -hex 8)
          
          # Save to environment
          echo "PRIVATE_KEY=$PRIVATE_KEY" >> $GITHUB_ENV
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
          echo "SHORT_ID=$SHORT_ID" >> $GITHUB_ENV
          
          # Display results
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    GENERATED KEYS                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… UUID: $UUID"
          echo "âœ… Private Key: $PRIVATE_KEY"
          echo "âœ… Public Key: $PUBLIC_KEY"
          echo "âœ… Short ID: $SHORT_ID"
          echo ""
          
          # Verify keys are not empty
          if [ -z "$PRIVATE_KEY" ] || [ -z "$PUBLIC_KEY" ]; then
            echo "âŒ ERROR: Keys are empty!"
            echo "Debug info:"
            cat /tmp/keys.txt
            exit 1
          fi
          
          echo "âœ… All keys generated successfully!"

      - name: Download GeoIP
        run: |
          mkdir -p /tmp/xray
          wget -q -O /tmp/xray/geoip.dat https://github.com/v2fly/geoip/releases/latest/download/geoip.dat
          wget -q -O /tmp/xray/geosite.dat https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat
          sudo cp /tmp/xray/*.dat /usr/local/bin/

      - name: Create VLESS Reality Config
        run: |
          cat > /tmp/xray/config.json << ENDCONFIG
          {
            "log": {
              "loglevel": "warning"
            },
            "inbounds": [
              {
                "listen": "0.0.0.0",
                "port": 443,
                "protocol": "vless",
                "settings": {
                  "clients": [
                    {
                      "id": "${UUID}",
                      "flow": "xtls-rprx-vision"
                    }
                  ],
                  "decryption": "none"
                },
                "streamSettings": {
                  "network": "tcp",
                  "security": "reality",
                  "realitySettings": {
                    "show": false,
                    "dest": "www.microsoft.com:443",
                    "xver": 0,
                    "serverNames": [
                      "www.microsoft.com",
                      "microsoft.com"
                    ],
                    "privateKey": "${PRIVATE_KEY}",
                    "shortIds": [
                      "${SHORT_ID}",
                      ""
                    ]
                  }
                },
                "sniffing": {
                  "enabled": true,
                  "destOverride": [
                    "http",
                    "tls",
                    "quic"
                  ]
                }
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom",
                "settings": {}
              }
            ]
          }
          ENDCONFIG
          
          echo "âœ… VLESS Reality config created"

      - name: Start Xray
        run: |
          cd /tmp/xray
          sudo nohup xray run -c config.json > xray.log 2>&1 &
          XRAY_PID=$!
          echo "XRAY_PID=$XRAY_PID" >> $GITHUB_ENV
          sleep 5
          
          if sudo ps -p $XRAY_PID > /dev/null; then
            echo "âœ… Xray started (PID: $XRAY_PID)"
            sudo ss -tlnp | grep :443
          else
            echo "âŒ Xray failed to start"
            cat /tmp/xray/xray.log
            exit 1
          fi

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Tunnel
        run: |
          if [ -z "${{ secrets.CF_TUNNEL_REALITY }}" ]; then
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘              CLOUDFLARE TUNNEL SETUP NEEDED                  â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "1. Go to: https://one.dash.cloudflare.com/"
            echo "2. Navigate to: Networks â†’ Tunnels"
            echo "3. Click: Create a tunnel"
            echo "4. Name it: iran-reality"
            echo "5. Copy the TOKEN (long string)"
            echo "6. Public Hostname settings:"
            echo "   - Subdomain: iran-pc"
            echo "   - Domain: duckdns.org (or your domain)"
            echo "   - Service Type: TCP"
            echo "   - URL: localhost:443"
            echo "7. Save the tunnel"
            echo "8. Go to your GitHub repository:"
            echo "   Settings â†’ Secrets and variables â†’ Actions"
            echo "9. Click: New repository secret"
            echo "   - Name: CF_TUNNEL_REALITY"
            echo "   - Value: [paste the token]"
            echo "10. Run this workflow again!"
            echo ""
            exit 1
          fi
          
          echo "ðŸš€ Starting Cloudflare tunnel..."
          nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_REALITY }}" > /tmp/cf.log 2>&1 &
          CF_PID=$!
          echo "CF_PID=$CF_PID" >> $GITHUB_ENV
          
          sleep 15
          
          if ps -p $CF_PID > /dev/null; then
            echo "âœ… Cloudflare tunnel running (PID: $CF_PID)"
            
            # Check if tunnel connected
            if grep -q "Connection.*registered" /tmp/cf.log; then
              echo "âœ… Tunnel connected successfully!"
            else
              echo "âš ï¸ Tunnel starting... check logs below:"
              cat /tmp/cf.log
            fi
          else
            echo "âŒ Cloudflare tunnel failed!"
            cat /tmp/cf.log
            exit 1
          fi

      - name: Display Connection Info
        run: |
          # Create VLESS link
          VLESS_LINK="vless://${UUID}@iran-pc.duckdns.org:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=www.microsoft.com&fp=chrome&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp&headerType=none#Iran-Reality"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                              â•‘"
          echo "â•‘      âœ… VLESS REALITY SERVER RUNNING! ðŸ‡®ðŸ‡·                   â•‘"
          echo "â•‘         Works on PC + Android (with right app)              â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“‹ SERVER DETAILS:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "Address: iran-pc.duckdns.org"
          echo "Port: 443"
          echo "Protocol: VLESS"
          echo "UUID: $UUID"
          echo "Flow: xtls-rprx-vision"
          echo "Security: reality"
          echo "SNI: www.microsoft.com"
          echo "Fingerprint: chrome"
          echo "Public Key: $PUBLIC_KEY"
          echo "Short ID: $SHORT_ID"
          echo "Network: tcp"
          echo ""
          echo "ðŸ”— VLESS LINK (Copy this):"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "$VLESS_LINK"
          echo ""
          echo "ðŸ’» FOR PC:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "1. Download v2rayN (Windows) or Qv2ray (Linux/Mac):"
          echo "   https://github.com/2dust/v2rayN/releases"
          echo "2. Copy the VLESS link above"
          echo "3. In v2rayN: Server â†’ Import from clipboard"
          echo "4. Connect!"
          echo ""
          echo "ðŸ“± FOR ANDROID:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âš ï¸ IMPORTANT: You need v2rayNG v1.8.0 or newer!"
          echo ""
          echo "OPTION 1 - v2rayNG (Recommended):"
          echo "1. Download LATEST version (v1.8.16+):"
          echo "   https://github.com/2dust/v2rayNG/releases"
          echo "   (Don't use Play Store - it's outdated!)"
          echo ""
          echo "2. Install the APK"
          echo "3. Copy the VLESS link above"
          echo "4. Open v2rayNG â†’ + â†’ Import from clipboard"
          echo "5. If imported config shows 'reality' in security â†’ You're good!"
          echo "6. Connect!"
          echo ""
          echo "OPTION 2 - Hiddify (Easier):"
          echo "1. Download: https://github.com/hiddify/hiddify-next/releases"
          echo "2. Install and import the VLESS link"
          echo "3. Works immediately!"
          echo ""
          echo "OPTION 3 - Matsuri (Alternative):"
          echo "1. Download: https://github.com/MatsuriDayo/Matsuri/releases"
          echo "2. Import VLESS link"
          echo "3. Better Reality support than old v2rayNG"
          echo ""
          echo "ðŸ”§ TROUBLESHOOTING ANDROID:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "If connection fails:"
          echo "1. Check app version (must be 1.8.0+)"
          echo "2. In config, try changing Fingerprint:"
          echo "   chrome â†’ firefox â†’ safari â†’ edge"
          echo "3. In Settings â†’ V2ray Core:"
          echo "   Try switching: xray â†” v2fly"
          echo "4. Restart app and phone"
          echo ""
          echo "âš¡ WHY THIS WORKS:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ… Reality protocol = Undetectable"
          echo "âœ… FAST (TCP direct connection)"
          echo "âœ… Same server works on PC + Android"
          echo "âœ… No need for VMess at all!"
          echo "âœ… More secure than traditional protocols"
          echo ""
          echo "â° RUNTIME: 6 hours maximum"
          echo "ðŸ”„ Re-run workflow after 6 hours"
          echo "ðŸ’¾ UUID and keys stay the same"
          echo ""
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯! ðŸ‡®ðŸ‡·"
          echo ""
          echo "ðŸ“ SAVE THESE CREDENTIALS:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "UUID: $UUID"
          echo "Public Key: $PUBLIC_KEY"
          echo "Short ID: $SHORT_ID"
          echo ""
          echo "Or just save the VLESS link above! â˜ï¸"

      - name: Monitor
        run: |
          echo ""
          echo "ðŸ‘€ Monitoring server (6 hours max)..."
          echo ""
          
          for i in {1..2160}; do
            # Check Xray
            if ! sudo ps -p $XRAY_PID > /dev/null 2>&1; then
              echo "âŒ Xray died at $(date)"
              cat /tmp/xray/xray.log
              exit 1
            fi
            
            # Check Cloudflare tunnel
            if ! ps -p $CF_PID > /dev/null 2>&1; then
              echo "ðŸ”„ Restarting Cloudflare tunnel at $(date)..."
              nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_REALITY }}" > /tmp/cf.log 2>&1 &
              CF_PID=$!
              echo "CF_PID=$CF_PID" >> $GITHUB_ENV
              sleep 10
            fi
            
            if [ $((i % 30)) -eq 0 ]; then
              echo "[$(date '+%H:%M:%S')] âœ… Server running | $((i * 10 / 60)) minutes elapsed"
            fi
            
            sleep 10
          done
          
          echo ""
          echo "â° 6 hour limit reached. Shutting down."

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          sudo kill $XRAY_PID 2>/dev/null || true
          kill $CF_PID 2>/dev/null || true
          echo "âœ… Cleanup complete"
