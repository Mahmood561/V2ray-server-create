name: VLESS XHTTP Cloudflare Tunnel

# This workflow runs a VLESS proxy server using XHTTP transport through
# Cloudflare Tunnel. It uses Cloudflare's TLS (not Reality) which is the
# only way to work reliably through Cloudflare tunnels.
#
# TWO MODES:
# 1. Quick Tunnel (default): No secrets needed, generates temporary URL
# 2. Token Tunnel: Add CF_TUNNEL_TOKEN secret for permanent URL

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip wget jq

      - name: Install Xray core
        run: |
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip
          sudo mv xray /usr/local/bin/xray
          sudo chmod +x /usr/local/bin/xray
          xray --version

      - name: Generate credentials
        run: |
          echo "Generating UUID..."
          UUID=$(xray uuid)
          echo "UUID=$UUID" >> $GITHUB_ENV
          
          # Generate random path for security
          RANDOM_PATH="/$(openssl rand -hex 8)"
          echo "XHTTP_PATH=$RANDOM_PATH" >> $GITHUB_ENV
          
          echo "UUID: $UUID"
          echo "Path: $RANDOM_PATH"

      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          cloudflared --version

      - name: Build Xray configuration
        run: |
          mkdir -p /tmp/xray
          
          cat > /tmp/xray/config.json <<EOF
          {
            "log": {
              "loglevel": "warning"
            },
            "inbounds": [
              {
                "listen": "127.0.0.1",
                "port": 8080,
                "protocol": "vless",
                "settings": {
                  "decryption": "none",
                  "clients": [
                    {
                      "id": "$UUID"
                    }
                  ]
                },
                "streamSettings": {
                  "network": "xhttp",
                  "xhttpSettings": {
                    "path": "$XHTTP_PATH"
                  }
                },
                "sniffing": {
                  "enabled": true,
                  "destOverride": ["http", "tls", "quic"]
                }
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom",
                "tag": "direct"
              },
              {
                "protocol": "blackhole",
                "tag": "block"
              }
            ]
          }
          EOF
          
          echo "Xray configuration created"
          cat /tmp/xray/config.json

      - name: Start Xray
        run: |
          nohup xray run -c /tmp/xray/config.json > /tmp/xray/xray.log 2>&1 &
          sleep 3
          
          if pgrep -x "xray" > /dev/null; then
            echo "Xray started successfully"
          else
            echo "Failed to start Xray"
            cat /tmp/xray/xray.log
            exit 1
          fi

      - name: Start Cloudflare Tunnel
        env:
          CF_TUNNEL_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
        run: |
          mkdir -p /tmp/tunnel
          
          if [ -n "$CF_TUNNEL_TOKEN" ]; then
            echo "Starting token-based tunnel..."
            echo "IMPORTANT: Make sure your Cloudflare tunnel is configured to route to http://localhost:8080"
            nohup cloudflared tunnel --no-autoupdate run --token "$CF_TUNNEL_TOKEN" > /tmp/tunnel/cloudflared.log 2>&1 &
            sleep 10
            
            if pgrep -x "cloudflared" > /dev/null; then
              echo "TUNNEL_MODE=token" >> $GITHUB_ENV
              echo "Token tunnel started"
              echo ""
              echo "=============================================="
              echo "TOKEN TUNNEL ACTIVE"
              echo "=============================================="
              echo "Your tunnel is running. Use the hostname you"
              echo "configured in the Cloudflare dashboard."
              echo ""
              echo "Make sure your tunnel public hostname points to:"
              echo "  Service: http://localhost:8080"
              echo "=============================================="
            else
              echo "Failed to start tunnel"
              cat /tmp/tunnel/cloudflared.log
              exit 1
            fi
          else
            echo "Starting quick tunnel (no token provided)..."
            nohup cloudflared tunnel --no-autoupdate --url http://localhost:8080 --logfile /tmp/tunnel/cloudflared.log > /tmp/tunnel/tunnel_url.log 2>&1 &
            
            # Wait for tunnel URL
            echo "Waiting for tunnel URL..."
            for i in {1..30}; do
              TUNNEL_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/tunnel/cloudflared.log 2>/dev/null | head -1)
              if [ -n "$TUNNEL_URL" ]; then
                echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
                echo "TUNNEL_MODE=quick" >> $GITHUB_ENV
                break
              fi
              sleep 2
            done
            
            if [ -z "$TUNNEL_URL" ]; then
              echo "Failed to get tunnel URL"
              cat /tmp/tunnel/cloudflared.log
              cat /tmp/tunnel/tunnel_url.log
              exit 1
            fi
            
            echo "Quick tunnel started: $TUNNEL_URL"
          fi

      - name: Print connection details
        run: |
          echo ""
          echo "=============================================="
          echo "       VLESS XHTTP CONNECTION DETAILS        "
          echo "=============================================="
          echo ""
          
          if [ "$TUNNEL_MODE" = "quick" ]; then
            # Extract hostname from URL
            HOSTNAME=$(echo "$TUNNEL_URL" | sed 's|https://||')
            
            echo "Server   : $HOSTNAME"
            echo "Port     : 443"
            echo "UUID     : $UUID"
            echo "Encryption: none"
            echo "Transport: xhttp (or splithttp/httpupgrade in some clients)"
            echo "Security : tls"
            echo "SNI      : $HOSTNAME"
            echo "Path     : $XHTTP_PATH"
            echo ""
            echo "----------------------------------------------"
            echo "VLESS URL (copy this):"
            echo "----------------------------------------------"
            ENCODED_PATH=$(echo "$XHTTP_PATH" | sed 's|/|%2F|g')
            echo "vless://$UUID@$HOSTNAME:443?encryption=none&security=tls&sni=$HOSTNAME&type=xhttp&path=$ENCODED_PATH#VLESS-XHTTP-CF"
            echo ""
            echo "----------------------------------------------"
            echo "Alternative URL (for clients using httpupgrade):"
            echo "----------------------------------------------"
            echo "vless://$UUID@$HOSTNAME:443?encryption=none&security=tls&sni=$HOSTNAME&type=httpupgrade&path=$ENCODED_PATH#VLESS-HTTPUpgrade-CF"
            echo ""
          else
            echo "Token tunnel mode - use your configured hostname"
            echo ""
            echo "UUID     : $UUID"
            echo "Port     : 443"
            echo "Encryption: none"
            echo "Transport: xhttp"
            echo "Security : tls"
            echo "Path     : $XHTTP_PATH"
            echo ""
            echo "Replace YOUR_HOSTNAME with your Cloudflare tunnel hostname:"
            ENCODED_PATH=$(echo "$XHTTP_PATH" | sed 's|/|%2F|g')
            echo "vless://$UUID@YOUR_HOSTNAME:443?encryption=none&security=tls&sni=YOUR_HOSTNAME&type=xhttp&path=$ENCODED_PATH#VLESS-XHTTP-CF"
          fi
          
          echo "=============================================="
          echo ""

      - name: Keep alive and monitor
        run: |
          echo "Workflow running. Cancel this action to stop."
          echo ""
          
          while true; do
            sleep 300
            
            # Check Xray
            if ! pgrep -x "xray" > /dev/null; then
              echo "Xray died, restarting..."
              nohup xray run -c /tmp/xray/config.json > /tmp/xray/xray.log 2>&1 &
              sleep 3
            fi
            
            # Check cloudflared
            if ! pgrep -x "cloudflared" > /dev/null; then
              echo "Cloudflared died, restarting..."
              if [ "$TUNNEL_MODE" = "quick" ]; then
                nohup cloudflared tunnel --no-autoupdate --url http://localhost:8080 --logfile /tmp/tunnel/cloudflared.log > /tmp/tunnel/tunnel_url.log 2>&1 &
                sleep 15
                NEW_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/tunnel/cloudflared.log 2>/dev/null | tail -1)
                if [ -n "$NEW_URL" ]; then
                  HOSTNAME=$(echo "$NEW_URL" | sed 's|https://||')
                  ENCODED_PATH=$(echo "$XHTTP_PATH" | sed 's|/|%2F|g')
                  echo ""
                  echo "NEW TUNNEL URL:"
                  echo "vless://$UUID@$HOSTNAME:443?encryption=none&security=tls&sni=$HOSTNAME&type=xhttp&path=$ENCODED_PATH#VLESS-XHTTP-CF"
                  echo ""
                fi
              else
                nohup cloudflared tunnel --no-autoupdate run --token "$CF_TUNNEL_TOKEN" > /tmp/tunnel/cloudflared.log 2>&1 &
              fi
              sleep 5
            fi
            
            echo "$(date): Services running OK"
          done
