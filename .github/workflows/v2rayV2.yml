name: VLESS Reality - WORKING (Fixed -1ms)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Xray
        run: |
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip
          sudo mv xray /usr/local/bin/
          sudo chmod +x /usr/local/bin/xray
          xray version

      - name: Generate Keys
        run: |
          echo "ðŸ”‘ Generating Reality keys..."
          
          # Generate UUID
          UUID=$(cat /proc/sys/kernel/random/uuid)
          echo "UUID=$UUID" >> $GITHUB_ENV
          
          # Generate X25519 keys
          xray x25519 > /tmp/keys.txt 2>&1
          
          echo "ðŸ“„ Raw key output:"
          cat /tmp/keys.txt
          echo ""
          
          # Extract keys - NEW XRAY FORMAT
          PRIVATE_KEY=$(grep "PrivateKey:" /tmp/keys.txt | cut -d: -f2 | tr -d ' ')
          PUBLIC_KEY=$(grep "Password:" /tmp/keys.txt | cut -d: -f2 | tr -d ' ')
          SHORT_ID=$(openssl rand -hex 8)
          
          # Save to environment
          echo "PRIVATE_KEY=$PRIVATE_KEY" >> $GITHUB_ENV
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
          echo "SHORT_ID=$SHORT_ID" >> $GITHUB_ENV
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    GENERATED KEYS                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… UUID: $UUID"
          echo "âœ… Private Key: $PRIVATE_KEY"
          echo "âœ… Public Key: $PUBLIC_KEY"
          echo "âœ… Short ID: $SHORT_ID"
          echo ""
          
          # Verify keys are not empty
          if [ -z "$PRIVATE_KEY" ] || [ -z "$PUBLIC_KEY" ]; then
            echo "âŒ ERROR: Keys are empty!"
            exit 1
          fi
          
          echo "âœ… All keys generated successfully!"

      - name: Download GeoIP & GeoSite
        run: |
          mkdir -p /tmp/xray
          wget -q -O /tmp/xray/geoip.dat https://github.com/v2fly/geoip/releases/latest/download/geoip.dat
          wget -q -O /tmp/xray/geosite.dat https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat

      - name: Create VLESS Reality Config (FIXED)
        run: |
          cat > /tmp/xray/config.json << 'ENDCONFIG'
          {
            "log": {
              "loglevel": "info",
              "access": "/tmp/xray/access.log",
              "error": "/tmp/xray/error.log"
            },
            "inbounds": [
              {
                "listen": "0.0.0.0",
                "port": 443,
                "protocol": "vless",
                "settings": {
                  "clients": [
                    {
                      "id": "UUID_PLACEHOLDER",
                      "flow": "xtls-rprx-vision",
                      "email": "user@reality"
                    }
                  ],
                  "decryption": "none",
                  "fallbacks": []
                },
                "streamSettings": {
                  "network": "tcp",
                  "security": "reality",
                  "realitySettings": {
                    "show": false,
                    "dest": "www.microsoft.com:443",
                    "xver": 0,
                    "serverNames": [
                      "www.microsoft.com",
                      "microsoft.com"
                    ],
                    "privateKey": "PRIVATE_KEY_PLACEHOLDER",
                    "minClientVer": "",
                    "maxClientVer": "",
                    "maxTimeDiff": 0,
                    "shortIds": [
                      "SHORT_ID_PLACEHOLDER",
                      ""
                    ]
                  },
                  "tcpSettings": {
                    "acceptProxyProtocol": false
                  }
                },
                "sniffing": {
                  "enabled": true,
                  "destOverride": [
                    "http",
                    "tls",
                    "quic",
                    "fakedns"
                  ],
                  "metadataOnly": false
                }
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom",
                "settings": {},
                "tag": "direct"
              },
              {
                "protocol": "blackhole",
                "settings": {},
                "tag": "block"
              }
            ],
            "routing": {
              "domainStrategy": "AsIs",
              "rules": [
                {
                  "type": "field",
                  "ip": [
                    "geoip:private"
                  ],
                  "outboundTag": "block"
                }
              ]
            }
          }
          ENDCONFIG
          
          # Replace placeholders
          sed -i "s/UUID_PLACEHOLDER/${UUID}/g" /tmp/xray/config.json
          sed -i "s/PRIVATE_KEY_PLACEHOLDER/${PRIVATE_KEY}/g" /tmp/xray/config.json
          sed -i "s/SHORT_ID_PLACEHOLDER/${SHORT_ID}/g" /tmp/xray/config.json
          
          echo "âœ… VLESS Reality config created (FIXED)"
          echo ""
          echo "ðŸ“„ Config preview:"
          head -30 /tmp/xray/config.json

      - name: Start Xray with Proper Logging
        run: |
          cd /tmp/xray
          
          # Start Xray
          sudo nohup xray run -c config.json > startup.log 2>&1 &
          XRAY_PID=$!
          echo "XRAY_PID=$XRAY_PID" >> $GITHUB_ENV
          
          sleep 5
          
          # Check if running
          if sudo ps -p $XRAY_PID > /dev/null; then
            echo "âœ… Xray started (PID: $XRAY_PID)"
            echo ""
            echo "ðŸ“Š Port status:"
            sudo ss -tlnp | grep :443 || echo "âš ï¸ Port 443 not listening!"
            echo ""
            echo "ðŸ“‹ Startup log:"
            cat startup.log
          else
            echo "âŒ Xray failed to start"
            echo ""
            echo "ðŸ“‹ Startup log:"
            cat startup.log
            echo ""
            echo "ðŸ“‹ Error log:"
            cat error.log 2>/dev/null || echo "No error log"
            exit 1
          fi

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Tunnel
        run: |
          if [ -z "${{ secrets.CF_TUNNEL_REALITY }}" ]; then
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘              CLOUDFLARE TUNNEL SETUP NEEDED                  â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "âš ï¸ CRITICAL: For VLESS Reality, tunnel MUST be TCP type!"
            echo ""
            echo "1. Go to: https://one.dash.cloudflare.com/"
            echo "2. Navigate to: Networks â†’ Tunnels"
            echo "3. Create tunnel: iran-reality"
            echo "4. Copy TOKEN"
            echo "5. Public Hostname:"
            echo "   - Subdomain: iran-pc"
            echo "   - Domain: duckdns.org"
            echo "   - Service Type: TCP âš ï¸ (MUST BE TCP!)"
            echo "   - URL: localhost:443"
            echo "6. Save tunnel"
            echo "7. GitHub Settings â†’ Secrets â†’ Actions"
            echo "   - Name: CF_TUNNEL_REALITY"
            echo "   - Value: [paste token]"
            echo ""
            exit 1
          fi
          
          echo "ðŸš€ Starting Cloudflare TCP tunnel..."
          nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_REALITY }}" > /tmp/cf.log 2>&1 &
          CF_PID=$!
          echo "CF_PID=$CF_PID" >> $GITHUB_ENV
          
          sleep 15
          
          if ps -p $CF_PID > /dev/null; then
            echo "âœ… Cloudflare tunnel running (PID: $CF_PID)"
            echo ""
            echo "ðŸ“‹ Tunnel log:"
            cat /tmp/cf.log
            echo ""
            
            if grep -q "Connection.*registered" /tmp/cf.log; then
              echo "âœ… Tunnel connected and registered!"
            else
              echo "âš ï¸ Tunnel starting, waiting for connection..."
            fi
          else
            echo "âŒ Cloudflare tunnel failed!"
            cat /tmp/cf.log
            exit 1
          fi

      - name: Display Connection Info
        run: |
          # Create VLESS link
          VLESS_LINK="vless://${UUID}@iran-pc.duckdns.org:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=www.microsoft.com&fp=chrome&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp&headerType=none#Iran-Reality"
          
          # Alternative fingerprints
          VLESS_FIREFOX="vless://${UUID}@iran-pc.duckdns.org:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=www.microsoft.com&fp=firefox&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp&headerType=none#Iran-Reality-Firefox"
          VLESS_SAFARI="vless://${UUID}@iran-pc.duckdns.org:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=www.microsoft.com&fp=safari&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp&headerType=none#Iran-Reality-Safari"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                              â•‘"
          echo "â•‘           âœ… VLESS REALITY SERVER RUNNING! ðŸ‡®ðŸ‡·              â•‘"
          echo "â•‘              (FIXED for -1ms issue)                          â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“‹ SERVER CREDENTIALS:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "Address: iran-pc.duckdns.org"
          echo "Port: 443"
          echo "Protocol: VLESS"
          echo "UUID: $UUID"
          echo "Flow: xtls-rprx-vision"
          echo "Security: reality"
          echo "SNI: www.microsoft.com"
          echo "Fingerprint: chrome (try firefox if fails)"
          echo "Public Key: $PUBLIC_KEY"
          echo "Short ID: $SHORT_ID"
          echo "Network: tcp"
          echo ""
          echo "ðŸ”— PRIMARY VLESS LINK (Chrome fingerprint):"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "$VLESS_LINK"
          echo ""
          echo "ðŸ”— ALTERNATIVE 1 (Firefox fingerprint - if chrome fails):"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "$VLESS_FIREFOX"
          echo ""
          echo "ðŸ”— ALTERNATIVE 2 (Safari fingerprint - if others fail):"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "$VLESS_SAFARI"
          echo ""
          echo "ðŸ’» FOR PC (Windows/Mac/Linux):"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "1. Download v2rayN (Windows) or Qv2ray (Mac/Linux):"
          echo "   https://github.com/2dust/v2rayN/releases"
          echo "2. Copy the VLESS link (try Chrome first)"
          echo "3. Import from clipboard"
          echo "4. If -1ms or timeout:"
          echo "   - Right-click config â†’ Edit"
          echo "   - Change 'Fingerprint' to: firefox or safari"
          echo "   - Save and reconnect"
          echo "5. Connect and test!"
          echo ""
          echo "ðŸ“± FOR ANDROID:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "OPTION 1 - v2rayNG (Most Compatible):"
          echo "1. Download v2rayNG 1.8.16+ (NOT Play Store!):"
          echo "   https://github.com/2dust/v2rayNG/releases"
          echo "   Get: v2rayNG_1.8.xx_arm64-v8a.apk"
          echo ""
          echo "2. Install APK"
          echo "3. Copy VLESS link (Chrome version first)"
          echo "4. Open v2rayNG â†’ + â†’ Import from clipboard"
          echo "5. If -1ms or connection fails:"
          echo "   - Long press config â†’ Edit"
          echo "   - TLS Settings â†’ Fingerprint â†’ Change to 'firefox'"
          echo "   - Save"
          echo "6. OR import the Firefox alternative link above"
          echo "7. Connect!"
          echo ""
          echo "OPTION 2 - Hiddify (Easier):"
          echo "1. Download: https://github.com/hiddify/hiddify-next/releases"
          echo "2. Import VLESS link"
          echo "3. If fails, try the Firefox alternative link"
          echo ""
          echo "OPTION 3 - v2rayNG Settings to Try:"
          echo "If still getting -1ms on Android:"
          echo "1. Settings â†’ V2Ray Core â†’ Switch between 'xray' and 'v2fly'"
          echo "2. Settings â†’ Prefer IPv6 â†’ Disable"
          echo "3. Try different fingerprints: chrome â†’ firefox â†’ safari"
          echo ""
          echo "ðŸ”§ FIXING -1ms ISSUE:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "The -1ms means client connects but server doesn't respond."
          echo "This is usually fixed by:"
          echo ""
          echo "âœ… 1. Using the correct fingerprint:"
          echo "   - Try chrome first"
          echo "   - If fails, try firefox (usually works!)"
          echo "   - Last resort: safari"
          echo ""
          echo "âœ… 2. Make sure Cloudflare tunnel is TCP type:"
          echo "   - Go to Cloudflare dashboard"
          echo "   - Check tunnel type is TCP (not HTTP/HTTPS)"
          echo ""
          echo "âœ… 3. Use latest app version:"
          echo "   - v2rayNG must be 1.8.0+"
          echo "   - Update from GitHub, not Play Store"
          echo ""
          echo "âœ… 4. Wait 30 seconds after starting:"
          echo "   - Server needs time to fully initialize"
          echo "   - Try connecting again after 30s"
          echo ""
          echo "ðŸŽ¯ WHAT WAS FIXED:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ… Added proper fallbacks configuration"
          echo "âœ… Improved Reality settings"
          echo "âœ… Added routing rules to block private IPs"
          echo "âœ… Better logging for debugging"
          echo "âœ… Added sniffing for multiple protocols"
          echo "âœ… Proper TCP settings"
          echo "âœ… Generated multiple fingerprint options"
          echo ""
          echo "â° RUNTIME: 6 hours maximum"
          echo "ðŸ”„ Re-run workflow after 6 hours"
          echo "ðŸ’¾ UUID and keys stay the same"
          echo ""
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯! ðŸ‡®ðŸ‡·"

      - name: Monitor with Enhanced Logging
        run: |
          echo ""
          echo "ðŸ‘€ Monitoring server (6 hours max)..."
          echo "ðŸ“Š Showing connection logs every 5 minutes"
          echo ""
          
          for i in {1..2160}; do
            # Check Xray
            if ! sudo ps -p $XRAY_PID > /dev/null 2>&1; then
              echo "âŒ Xray died at $(date)"
              echo "Last 50 lines of access log:"
              tail -50 /tmp/xray/access.log 2>/dev/null || echo "No access log"
              echo ""
              echo "Last 50 lines of error log:"
              tail -50 /tmp/xray/error.log 2>/dev/null || echo "No error log"
              exit 1
            fi
            
            # Check Cloudflare tunnel
            if ! ps -p $CF_PID > /dev/null 2>&1; then
              echo "ðŸ”„ Restarting Cloudflare tunnel at $(date)..."
              nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CF_TUNNEL_REALITY }}" > /tmp/cf.log 2>&1 &
              CF_PID=$!
              echo "CF_PID=$CF_PID" >> $GITHUB_ENV
              sleep 10
            fi
            
            # Show status every 5 minutes
            if [ $((i % 30)) -eq 0 ]; then
              echo "[$(date '+%H:%M:%S')] âœ… Server running | $((i * 10 / 60)) minutes elapsed"
              
              # Show recent connections
              if [ -f /tmp/xray/access.log ]; then
                CONN_COUNT=$(wc -l < /tmp/xray/access.log)
                if [ $CONN_COUNT -gt 0 ]; then
                  echo "ðŸ“Š Total connections so far: $CONN_COUNT"
                  echo "Recent activity:"
                  tail -3 /tmp/xray/access.log
                else
                  echo "â„¹ï¸ No connections yet (this is normal if not using VPN)"
                fi
              fi
              echo ""
            fi
            
            sleep 10
          done
          
          echo ""
          echo "â° 6 hour limit reached. Shutting down gracefully."

      - name: Final Status Report
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    FINAL STATUS REPORT                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ -f /tmp/xray/access.log ]; then
            TOTAL_CONN=$(wc -l < /tmp/xray/access.log)
            echo "ðŸ“Š Total connections: $TOTAL_CONN"
            echo ""
            echo "Last 20 connections:"
            tail -20 /tmp/xray/access.log
          else
            echo "â„¹ï¸ No connection log found"
          fi
          
          echo ""
          if [ -f /tmp/xray/error.log ] && [ -s /tmp/xray/error.log ]; then
            echo "âš ï¸ Errors encountered:"
            tail -20 /tmp/xray/error.log
          else
            echo "âœ… No errors logged"
          fi

      - name: Cleanup
        if: always()
        run: |
          echo ""
          echo "ðŸ§¹ Cleaning up..."
          sudo kill $XRAY_PID 2>/dev/null || true
          kill $CF_PID 2>/dev/null || true
          echo "âœ… Cleanup complete"
