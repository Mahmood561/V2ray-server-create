name: Iran VLESS Reality - Final Working Version

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Xray
        run: |
          echo "ðŸ“¦ Installing Xray-core..."
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip
          sudo mv xray /usr/local/bin/
          sudo chmod +x /usr/local/bin/xray
          xray version
          echo "âœ… Xray installed"

      - name: Generate Reality Keys
        run: |
          echo "ðŸ” Generating Reality X25519 keypair..."
          xray x25519 > /tmp/keys.txt 2>&1
          
          PRIVATE_KEY=$(grep -i "private" /tmp/keys.txt | grep -oE '[A-Za-z0-9_-]{43}' | head -1)
          PUBLIC_KEY=$(grep -i "public" /tmp/keys.txt | grep -oE '[A-Za-z0-9_-]{43}' | head -1)
          UUID=$(cat /proc/sys/kernel/random/uuid)
          SHORT_ID=$(openssl rand -hex 8)
          
          echo "PRIVATE_KEY=$PRIVATE_KEY" >> $GITHUB_ENV
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
          echo "UUID=$UUID" >> $GITHUB_ENV
          echo "SHORT_ID=$SHORT_ID" >> $GITHUB_ENV
          
          echo "âœ… Keys generated successfully"
          echo "UUID: $UUID"
          echo "Public Key: $PUBLIC_KEY"
          echo "Short ID: $SHORT_ID"

      - name: Download GeoIP Files
        run: |
          echo "ðŸ“¥ Downloading geo files..."
          mkdir -p /tmp/xray
          
          wget -q -O /tmp/xray/geoip.dat https://github.com/v2fly/geoip/releases/latest/download/geoip.dat
          wget -q -O /tmp/xray/geosite.dat https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat
          
          sudo cp /tmp/xray/geoip.dat /usr/local/bin/geoip.dat
          sudo cp /tmp/xray/geosite.dat /usr/local/bin/geosite.dat
          
          echo "âœ… Geo files installed"

      - name: Create Xray Config
        run: |
          cat > /tmp/xray/config.json << ENDCONFIG
          {
            "log": {
              "loglevel": "warning"
            },
            "dns": {
              "servers": [
                "https+local://8.8.8.8/dns-query",
                "8.8.8.8",
                "1.1.1.1",
                "localhost"
              ],
              "queryStrategy": "UseIPv4"
            },
            "inbounds": [
              {
                "listen": "0.0.0.0",
                "port": 443,
                "protocol": "vless",
                "settings": {
                  "clients": [
                    {
                      "id": "${UUID}",
                      "flow": "xtls-rprx-vision"
                    }
                  ],
                  "decryption": "none"
                },
                "streamSettings": {
                  "network": "tcp",
                  "security": "reality",
                  "realitySettings": {
                    "show": false,
                    "dest": "www.microsoft.com:443",
                    "xver": 0,
                    "serverNames": [
                      "www.microsoft.com",
                      "microsoft.com"
                    ],
                    "privateKey": "${PRIVATE_KEY}",
                    "shortIds": [
                      "${SHORT_ID}",
                      ""
                    ]
                  }
                },
                "sniffing": {
                  "enabled": true,
                  "destOverride": ["http", "tls", "quic", "fakedns"],
                  "metadataOnly": false
                }
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom",
                "tag": "direct",
                "settings": {
                  "domainStrategy": "UseIPv4"
                }
              },
              {
                "protocol": "blackhole",
                "tag": "block"
              }
            ],
            "routing": {
              "domainStrategy": "IPIfNonMatch",
              "rules": [
                {
                  "type": "field",
                  "outboundTag": "direct",
                  "domain": [
                    "geosite:category-ads-all"
                  ]
                },
                {
                  "type": "field",
                  "outboundTag": "block",
                  "protocol": ["bittorrent"]
                }
              ]
            }
          }
          ENDCONFIG
          
          echo "âœ… Xray config created with DNS and routing fixes"
          cat /tmp/xray/config.json

      - name: Start Xray Server
        run: |
          echo "ðŸš€ Starting Xray with Reality protocol..."
          cd /tmp/xray
          
          # Run Xray with sudo to bind to port 443
          sudo nohup xray run -c config.json > xray.log 2>&1 &
          XRAY_PID=$!
          echo "XRAY_PID=$XRAY_PID" >> $GITHUB_ENV
          
          sleep 5
          
          # Check if process is running
          if sudo ps -p $XRAY_PID > /dev/null; then
            echo "âœ… Xray started successfully (PID: $XRAY_PID)"
          else
            echo "âŒ Xray failed to start"
            cat /tmp/xray/xray.log
            exit 1
          fi
          
          # Check if port 443 is listening
          if sudo ss -tlnp | grep :443; then
            echo "âœ… Listening on port 443"
          else
            echo "âŒ Port 443 not listening"
            cat /tmp/xray/xray.log
            exit 1
          fi

      - name: Install Cloudflared
        run: |
          echo "ðŸ“¦ Installing Cloudflared..."
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          cloudflared --version

      - name: Start Cloudflare Tunnel
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                                                              â•‘"
            echo "â•‘   ðŸ‡®ðŸ‡· VLESS REALITY FOR IRAN - SETUP INSTRUCTIONS          â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "âœ… CORRECT PROTOCOL FOR IRAN: VLESS + TCP + Reality"
            echo ""
            echo "ðŸ“ CLOUDFLARE TUNNEL SETUP:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "1. Go to: https://one.dash.cloudflare.com/"
            echo "2. Networks â†’ Tunnels â†’ Create a tunnel"
            echo "3. Name: iran-reality"
            echo "4. Save tunnel â†’ Copy TOKEN (starts with eyJ)"
            echo ""
            echo "5. Configure Public Hostname:"
            echo "   â€¢ Subdomain: iran-v2ray"
            echo "   â€¢ Domain: duckdns.org"
            echo "   â€¢ Service Type: TCP âš ï¸ (NOT HTTP!)"
            echo "   â€¢ URL: localhost:443"
            echo "   â€¢ Save"
            echo ""
            echo "6. Add to GitHub:"
            echo "   â€¢ Settings â†’ Secrets â†’ Actions"
            echo "   â€¢ New secret: CLOUDFLARE_TUNNEL_TOKEN"
            echo "   â€¢ Paste token â†’ Add secret"
            echo ""
            echo "7. Run this workflow again!"
            echo ""
            echo "âš ï¸  CRITICAL: Service must be TCP, not HTTP!"
            echo ""
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          
          echo "ðŸš€ Starting Cloudflare TCP tunnel..."
          nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" > /tmp/cloudflared.log 2>&1 &
          CLOUDFLARED_PID=$!
          echo "CLOUDFLARED_PID=$CLOUDFLARED_PID" >> $GITHUB_ENV
          
          sleep 15
          
          if ps -p $CLOUDFLARED_PID > /dev/null; then
            echo "âœ… Cloudflare tunnel connected successfully"
            cat /tmp/cloudflared.log
          else
            echo "âŒ Tunnel failed to start"
            cat /tmp/cloudflared.log
            exit 1
          fi

      - name: Display Connection Info
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                              â•‘"
          echo "â•‘        âœ… SERVER READY! Ø³Ø±ÙˆØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª ðŸ‡®ðŸ‡·                 â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ”‘ YOUR CREDENTIALS (Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "UUID: $UUID"
          echo "Public Key: $PUBLIC_KEY"
          echo "Short ID: $SHORT_ID"
          echo ""
          echo "ðŸŒ YOUR SERVER ADDRESS (Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ±):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "iran-v2ray.duckdns.org:443"
          echo ""
          echo "ðŸ“± V2RAYN/V2RAYNG CONFIGURATION:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Protocol: VLESS"
          echo "Address: iran-v2ray.duckdns.org"
          echo "Port: 443"
          echo "UUID: $UUID"
          echo "Flow: xtls-rprx-vision âš ï¸ IMPORTANT!"
          echo "Encryption: none"
          echo "Network: tcp"
          echo "Security: reality"
          echo "SNI: www.microsoft.com"
          echo "Fingerprint: chrome âš ï¸ IMPORTANT!"
          echo "PublicKey: $PUBLIC_KEY"
          echo "ShortId: $SHORT_ID"
          echo ""
          echo "ðŸ”— VLESS LINK (Ù„ÛŒÙ†Ú© Ú©Ø§Ù…Ù„):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "vless://${UUID}@iran-v2ray.duckdns.org:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=www.microsoft.com&fp=chrome&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp#Iran-Reality"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“² DOWNLOAD V2RAYNG:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Android: https://github.com/2dust/v2rayNG/releases"
          echo "Download: v2rayNG_1.8.x_arm64-v8a.apk"
          echo ""
          echo "Windows: https://github.com/2dust/v2rayN/releases"
          echo "Download: v2rayN-windows-64.zip"
          echo ""
          echo "ðŸ“‹ HOW TO CONNECT (Ù†Ø­ÙˆÙ‡ Ø§ØªØµØ§Ù„):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "METHOD 1 - Copy Link (Ø±Ø§Ù‡ Ø§ÙˆÙ„ - Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©):"
          echo "  1. Copy the VLESS link above"
          echo "  2. Open v2rayNG"
          echo "  3. Click '+' â†’ Import from clipboard"
          echo "  4. Connect!"
          echo ""
          echo "METHOD 2 - Manual Entry (Ø±Ø§Ù‡ Ø¯ÙˆÙ… - Ø¯Ø³ØªÛŒ):"
          echo "  1. Open v2rayNG"
          echo "  2. Click '+' â†’ Type manually [VLESS]"
          echo "  3. Enter ALL details from above"
          echo "  4. âš ï¸ IMPORTANT: Set Flow to 'xtls-rprx-vision'"
          echo "  5. âš ï¸ IMPORTANT: Set Fingerprint to 'chrome'"
          echo "  6. Save and Connect!"
          echo ""
          echo "âœ… WHAT WORKS:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Telegram"
          echo "âœ… Instagram"
          echo "âœ… YouTube"
          echo "âœ… Twitter/X"
          echo "âœ… WhatsApp"
          echo "âœ… All websites"
          echo "âœ… Fast speed"
          echo "âœ… Stable connection"
          echo ""
          echo "ðŸŒŸ WHY THIS IS THE BEST:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Reality: Traffic looks exactly like microsoft.com"
          echo "âœ… Can't be detected by Iran's DPI"
          echo "âœ… TCP + Vision = Maximum speed"
          echo "âœ… Port 443 = Standard HTTPS"
          echo "âœ… Free and unlimited"
          echo ""
          echo "â° RUNTIME (Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  Maximum 6 hours (GitHub Actions limit)"
          echo "âš ï¸  After 6 hours, run workflow again"
          echo "âš ï¸  Your UUID/Keys stay the same"
          echo "âš ï¸  Just reconnect with same config"
          echo ""
          echo "ðŸ’° FOR 24/7 FREE SERVICE:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Use Oracle Cloud (Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡):"
          echo "  1. Sign up: https://cloud.oracle.com/"
          echo "  2. Create free VM (Ubuntu 22.04)"
          echo "  3. Install same Xray config"
          echo "  4. Runs 24/7 forever!"
          echo ""
          echo "ðŸ”§ TROUBLESHOOTING:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Can't connect?"
          echo "  â†’ Check Flow is 'xtls-rprx-vision'"
          echo "  â†’ Check Fingerprint is 'chrome'"
          echo "  â†’ Check SNI is 'www.microsoft.com'"
          echo "  â†’ Try restarting v2rayNG"
          echo ""
          echo "âŒ Slow speed?"
          echo "  â†’ This is normal on GitHub Actions"
          echo "  â†’ Use Oracle Cloud for better speed"
          echo ""
          echo "âŒ Server stopped after 6 hours?"
          echo "  â†’ Normal! Just run workflow again"
          echo "  â†’ Same config will work"
          echo ""
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸŽ‰ Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯! Good luck! ðŸ‡®ðŸ‡·"
          echo ""

      - name: Monitor Server
        run: |
          echo ""
          echo "ðŸ‘€ Server running... Maximum 6 hours"
          echo "ðŸ›‘ Click 'Cancel workflow' to stop"
          echo ""
          
          for i in {1..2160}; do
            if ! sudo ps -p $XRAY_PID > /dev/null 2>&1; then
              echo "âŒ Xray stopped"
              cat /tmp/xray/xray.log
              exit 1
            fi
            
            if ! ps -p $CLOUDFLARED_PID > /dev/null 2>&1; then
              echo "âš ï¸  Cloudflared stopped, restarting..."
              nohup cloudflared tunnel --no-autoupdate run --token "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" > /tmp/cloudflared.log 2>&1 &
              CLOUDFLARED_PID=$!
              echo "CLOUDFLARED_PID=$CLOUDFLARED_PID" >> $GITHUB_ENV
              sleep 10
            fi
            
            if [ $((i % 30)) -eq 0 ]; then
              UPTIME=$((i * 10 / 60))
              echo "[$(date '+%H:%M:%S')] âœ… Running | Uptime: ${UPTIME} minutes"
            fi
            
            sleep 10
          done
          
          echo ""
          echo "â° 6 hours reached"
          echo "ðŸ”„ Run workflow again to restart server"

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          sudo kill $XRAY_PID 2>/dev/null || true
          kill $CLOUDFLARED_PID 2>/dev/null || true
          echo "âœ… Done"
